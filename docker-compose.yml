name: legal_ai_1c

services:
  qdrant:
    image: qdrant/qdrant:latest
    container_name: qdrant
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant_data:/qdrant/storage
    restart: unless-stopped

  backend:
    image: legal-ai/backend:dev
    build:
      context: ./backend
      dockerfile: Dockerfile
      args:
        BASE_IMAGE: legal-ai/backend-base:cu130
    container_name: backend
    environment:
      - OLLAMA_BASE_URL=http://host.docker.internal:11434
      - OLLAMA_MODEL=${OLLAMA_MODEL}
      - QDRANT_URL=${QDRANT_URL}
      - QDRANT_COLLECTION=${QDRANT_COLLECTION}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL}
      - RAG_TOP_K=${RAG_TOP_K}
      - EMBED_DEVICE=auto
      - PYTORCH_ALLOC_CONF=max_split_size_mb:256,expandable_segments:True
      # настройки стартовых проверок (выполнятся в app.startup)
      - STARTUP_CHECKS=1
      - STARTUP_CUDA_NAME=0      # имя GPU можно включать позже
      - SELF_CHECK_TIMEOUT=5   # ждать ollama/qdrant до N секунд
      - SELF_CHECK_GEN=0        # 1 = сделать тест-генерацию через ollama
      - EMBED_PRELOAD=0         # 1 = прогрузить эмбеддер на старте
      # Reranker
      - RERANK_ENABLE=1
      - RERANK_PRELOAD=0
      - RERANKER_MODEL=BAAI/bge-reranker-v2-m3
      - RERANK_DEVICE=auto          # auto|cuda|cpu
      - RERANK_KEEP=5               # сколько оставить после rerank из топ-K
      - RERANK_BATCH=16             # батч скоринга
      - RERANK_DEBUG=0              # 1 = печатать скоры в логи
      # Net-tests
      - NET_TEST_URLS=https://publication.pravo.gov.ru/,https://pravo.gov.ru/,https://docs.cntd.ru/

    depends_on:
      qdrant:
        condition: service_started
    volumes:
      - ./:/workspace
      # - ./.hf_cache:/root/.cache/huggingface
    extra_hosts:
      - "host.docker.internal:host-gateway"
    working_dir: /workspace/backend
    # просто запускаем uvicorn — без shell-скриптов
    command: uvicorn app:app --host 0.0.0.0 --port 8087 --reload --log-level info
    ports:
      - "8087:8087"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:8087/health >/dev/null || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 20
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: ["gpu"]
    restart: unless-stopped

volumes:
  qdrant_data:
    name: legal_ai_1c_qdrant_data
