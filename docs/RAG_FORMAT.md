# Формат корпуса для Qdrant

Legal AI хранит нормативные акты во внешнем Qdrant, используя эмбеддинги `BAAI/bge-m3` (размерность 1024, cosine). Этот документ описывает, как подготовить и загрузить данные.

## 1. Единица хранения

Каждая строка JSONL — одна логическая сущность: статья, часть, пункт или иной минимальный фрагмент. Чем мельче дробление, тем точнее ссылки в отчёте.

## 2. Обязательные поля

```json
{
  "act_id": "gk_rf_part1",
  "act_title": "ГК РФ (Часть первая)",
  "jurisdiction": "RU",
  "text": "Существенные условия договора...",
  "local_ref": "gkrf/ch1/art432"
}
```

Рекомендуемые поля: `article`, `part`, `point`, `revision_date` (YYYY-MM-DD), `local_ref` с иерархией (`gkrf/ch1/art432/p3/2`).

## 3. Идентификаторы

Для устойчивых обновлений используйте детерминированные ключи:

- `source_hash` — первые 16 символов `sha256(text)`.
- `point_id` — 64-битное число `int(sha1(local_ref or text)[:16], 16)`.

Такая схема совпадает с тем, что ожидает backend, и позволяет безопасно переиндексировать записи без дублей.

## 4. Размерность

- Эмбеддинги: `BAAI/bge-m3` → 1024 измерения.
- Qdrant коллекция: `ru_law_m3`, метрика `cosine`.
- Используйте одну и ту же модель при индексации и поиске. Несовпадение размерности приведёт к ошибке.

## 5. Демонстрационный корпус

В репозитории есть `corpus/ru_sample.jsonl`. Используйте его как пример структуры записей при построении собственных пайплайнов индексации. Каталоги для файлов контролируются переменными `LEGAL_AI_CORPUS_DIR` и `LEGAL_AI_LOCAL_BASE`.

## 6. Загрузка данных в Qdrant

Backend не предоставляет API для индексации. Чтобы загрузить данные:

1. Подготовьте JSONL-файл со структурами, описанными выше.
2. Вычислите эмбеддинги через Ollama `POST /api/embeddings`, используя модель из переменной `EMBEDDING_MODEL`.
3. Отправьте точки в Qdrant через его REST API (`/collections/{collection}/points`) или официальные SDK.
4. При необходимости обновляйте или удаляйте записи также через API Qdrant.

Загружайте батчи по 1–5 тыс. записей, контролируя потребление памяти при вычислении эмбеддингов.

## 7. Рекомендации по качеству

- Удаляйте технические вставки, мусорные символы, сноски.
- Фиксируйте дату редакции и источник.
- Формируйте `local_ref` в стабильном иерархическом формате.
- Периодически делайте snapshot'ы Qdrant для бэкапа.
