# RAG_FORMAT — подготовка и загрузка НПА

## Цель
Обеспечить точные ссылки на нормы РФ в отчёте. База знаний хранится в Qdrant, поиск — BGE-M3 (dense) → **GPU-реранкер** bge-reranker-v2-m3.

## 1) Единица хранения
**Одна запись JSONL = одна логическая единица**:
- статья (`article`)
- часть (`part`)
- пункт (`point`)

> Чем мельче (до пункта), тем точнее ссылки и контекст.

## 2) Схема записи (JSONL)

Обязательные:
- `act_id` *(строка)* — стабильный ID акта (напр., `gk_rf_part1`)
- `act_title` *(строка)* — человекочитаемое название
- `text` *(строка)* — полный текст единицы
- `jurisdiction` *(строка)* — `"RU"`

Рекомендуемые:
- `article` *(строка)* — номер статьи (может содержать точки: `431.2`)
- `part` *(строка)* — номер части
- `point` *(строка)* — номер пункта/подпункта
- `revision_date` *(YYYY-MM-DD)* — редакция
- `local_ref` *(строка)* — стабильная ссылка вида `gkrf/ch1/art432/p3/2`

### Пример (статья)
```json
{"act_id":"gk_rf_part1","act_title":"ГК РФ (Часть первая)","article":"432","revision_date":"2025-01-01","jurisdiction":"RU","text":"Существенные условия договора...","local_ref":"gkrf/ch1/art432"}
```

### Пример (пункт)
```json
{"act_id":"gk_rf_part1","act_title":"ГК РФ (Часть первая)","article":"432","part":"3","point":"2","revision_date":"2025-01-01","jurisdiction":"RU","text":"Текст пункта 2 части 3 статьи 432...","local_ref":"gkrf/ch1/art432/p3/2"}
```

## 3) Идентификаторы и дедупликация

- При ingest формируется детерминированный ID точки как sha1(local_ref or text) → int.

- Повторная загрузка той же local_ref приводит к upsert без дублей.

- В ответе API дополнительно убираются дубликаты по source_hash.

## 4) Размерности и коллекция

- Эмбеддер: BGE-M3 → размерность вектора 1024, метрика cosine.

- Коллекция Qdrant: ru_law_m3 создаётся автоматически.

- Код совместим с версиями клиента, где нужен vectors или vectors_config.

## 5) Загрузка корпуса

Через файл (демо)
```bash
corpus/ru_sample.jsonl
```
```bash
curl -s -X POST http://localhost:8000/rag/ingest_sample | jq
```

Через API (пакетно)
```bash
curl -s -X POST http://localhost:8000/rag/ingest \
  -H 'Content-Type: application/json' \
  -d '{"items":[
    {"act_id":"gk_rf_part1","act_title":"ГК РФ (Часть первая)","article":"432","revision_date":"2025-01-01","jurisdiction":"RU","text":"...","local_ref":"gkrf/ch1/art432"},
    {"act_id":"gk_rf_part1","act_title":"ГК РФ (Часть первая)","article":"431.2","jurisdiction":"RU","text":"...","local_ref":"gkrf/ch1/art431_2"}
  ]}'
```

**Рекомендации:**

- Грузите батчами по 1–5 тыс. записей.

- Следите за RAM при кодировании (BGE-M3) — можно понижать батч у SentenceTransformer при необходимости.

## 6) Нормализация и ссылки

- local_ref делайте иерархичной и человекочитаемой (код_акта/глава/статья/часть/пункт).

- Преобразуйте входящие ссылки вида «п. 3 ст. 432 ГК РФ» к local_ref — пригодится при розыске точной нормы.

## 7) Поиск и rerank

- Поиск: dense-вектор по тексту договора/вопроса, фильтр jurisdiction="RU".

- Rerank: bge-reranker-v2-m3 сортирует top-K кандидатов, оставляем RERANK_KEEP (по умолчанию 5).

- Для повышения точности можно добавить гибрид (BM25) и объединять кандидатов перед rerank.

## 8) Качество корпуса

- Избегайте «склейки» больших блоков (разбивайте по статье/части/пункту).

- Указывайте revision_date — полезно для версионирования.

- Чистите служебные примечания, сноски, мусорные символы.

- Для актов с большим количеством редакций — храните актуальную, либо помечайте несколько редакций и фильтруйте на ingest.

## 9) Ограничения и советы

- Оффлайн: предварительно прогрейте HF-кэш (эмбеддер/реранкер) и держите его смонтированным.

- Токены LLM: указывайте max_tokens разумно (256–700), чтобы ответ был быстрым и стабильным.

- Секьюрность: не храните в корпусе персональные/чувствительные данные без необходимости.